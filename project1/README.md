# SM4 高性能密码库

本项目致力于实现并优化国家商用密码算法 SM4 的软件执行效率。项目从 SM4 的基础实现出发，逐步集成了多种优化策略，并提供了完整、严谨的测试和性能评估框架。

## SM4 算法原理

SM4 是一种分组密码算法，其分组长度和密钥长度均为 128 位（16 字节）。该算法采用非平衡 Feistel 结构，加密和解密过程的结构相似，但轮密钥的使用顺序相反。

### 1. 轮函数 F

SM4 的轮函数 F 是算法的核心，其结构如下：
`F(X₀, X₁, X₂, X₃, rk) = X₀ ⊕ T(X₁ ⊕ X₂ ⊕ X₃ ⊕ rk)`
其中，`X₀, X₁, X₂, X₃` 是输入的四个 32 位字，`rk` 是 32 位的轮密钥。

### 2. 合成置换 T

变换 `T` 是一个复合变换，由一个非线性变换 `τ` 和一个线性变换 `L` 组成：
`T(A) = L(τ(A))`
- **非线性变换 τ**: 该变换对输入的 32 位字 `A` 的每个字节分别应用 S-box。
- **线性变换 L**: 该变换增强算法的扩散属性，确保单个输入位的变化能快速影响到多个输出位。其定义为：
  `L(B) = B ⊕ (B <<< 2) ⊕ (B <<< 10) ⊕ (B <<< 18) ⊕ (B <<< 24)`
  其中，`B` 是 `τ` 变换后的 32 位输出，`<<<` 表示循环左移。

### 3. S-box

S-box 是 SM4 算法中唯一的非线性组件，用于提供密码学上的混淆。它是一个固定的 8 位输入、8 位输出的置换，其设计基于有限域 `GF(2⁸)` 上的运算，具有良好的抗密码分析（如差分分析和线性分析）特性。

### 4. 密钥扩展

SM4 的密钥扩展算法从用户提供的 128 位主密钥 `MK` 中生成 32 个 32 位的轮密钥 `rk₀, rk₁, ..., rk₃₁`。该过程同样使用了 S-box 和一个类似的线性变换，确保了轮密钥的随机性和独立性。

## 项目目标

优化 SM4 的软件执行效率，至少应该覆盖 T-table、AES-NI 以及最新的指令集（如 GFNI、VPROLD 等）。

## 已实现功能

根据当前项目进展，我们已经成功实现了以下部分：

- **标准 SM4 算法实现**: 遵循官方标准，实现了 SM4 算法的基础版本，确保了算法的正确性和兼容性。
- **多种工作模式**:
  - **ECB (Electronic Codebook)**: 电子密码本模式
  - **CBC (Cipher Block Chaining)**: 密码块链接模式
  - **CTR (Counter)**: 计数器模式
- **软件优化技术**:
  - **T-table (表格查询) 优化**: 通过预计算和查表，显著减少了轮函数中的 S-box 查找和线性变换，大幅提升了加密和解密的速度。
  - **AES-NI (高级加密标准新指令) 优化**: 尝试利用现代 CPU 中的 `AES-NI` 指令集来加速 SM4 的非线性变换部分。

## 项目状态与分析

项目已成功实现了 **T-table** 和 **AES-NI** 两种核心优化方案。

- **T-table 优化** 取得了非常显著的效果，根据基准测试结果，其性能相较于基础实现有 **~1.77倍** 的提升，证明了该优化策略在提升 SM4 软件执行效率上的有效性。
- **AES-NI 优化** 的初步实现已经完成，并通过了正确性测试。然而，在当前的性能基准测试中，其表现（`0.63x`）劣于基础实现。这可能是由于多种因素造成的，例如指令调用的开销、数据准备的延迟或与 SM4 算法特性的适配问题。这部分将是未来工作的重点，需要进一步分析和优化，以发挥 `AES-NI` 指令集的真正潜力。
- 关于 **GFNI (Galois Field New Instructions)** 和 **VPROLD** 等更先进的指令集，目前尚未在本项目的代码中实现，可作为下一阶段的优化目标。

## 构建与测试

本项目使用 `Makefile` 进行管理，提供了简洁的构建和测试命令。

### 环境要求
- `gcc` 编译器
- `make` 构建工具
- (可选) `clang-format` 用于代码格式化
- (可选) `cppcheck` 用于静态代码分析

### 构建项目
克隆仓库后，在 `project1` 目录下执行：
```bash
make all
```
该命令将编译生成所有静态库、测试程序和示例程序。

### 运行测试
执行以下命令以验证所有实现的正确性：
```bash
make test
```
测试套件将覆盖基础实现、所有工作模式以及优化版本的正确性。

### 运行性能基准测试
执行以下命令以评估不同实现的性能：
```bash
make benchmark
```

## 性能基准测试结果

以下是在测试环境上收集的性能数据，测试数据块大小为 1MB，迭代 10 次。

**CPU 特性:**
- AES-NI: **支持**
- AVX: **支持**

### ECB 模式性能对比

| 实现方式             | 平均速度 (MB/s) | 峰值速度 (MB/s) | 谷值速度 (MB/s) | 每字节周期 (Cycles/Byte) | 加速比 |
| -------------------- | --------------- | --------------- | --------------- | ------------------------ | ------ |
| **基础实现**         | 84.68           | 92.14           | 80.13           | 33.55                    | 1.00x  |
| **T-table 优化**     | 150.01          | 155.50          | 143.89          | 18.93                    | **1.77x**  |
| **AES-NI 优化**      | 53.02           | 59.27           | 47.37           | 53.57                    | 0.63x  |

### 不同数据块大小下的性能

| 数据块大小 | 基础实现 (MB/s) | T-table 实现 (MB/s) | 加速比 |
| ---------- | --------------- | ------------------- | ------ |
| 16 B       | 31.38           | 42.35               | 1.35x  |
| 64 B       | 31.84           | 127.53              | 4.01x  |
| 256 B      | 78.27           | 138.10              | 1.76x  |
| 1 KB       | 73.64           | 143.88              | 1.95x  |
| 4 KB       | 83.72           | 147.03              | 1.76x  |
| 16 KB      | 90.04           | 151.55              | 1.68x  |
| 64 KB      | 89.45           | 142.28              | 1.59x  |
| 256 KB     | 84.73           | 132.22              | 1.56x  |

## 未来工作

1.  **深度优化 AES-NI 实现**: 分析当前 AES-NI 版本性能瓶颈，并进行针对性优化。
2.  **探索并实现 GFNI/VPROLD 指令集优化**: 研究并引入更现代的 CPU 指令集，以进一步提升性能。
3.  **完善文档**: 为核心函数和模块添加更详细的 Doxygen 文档。
