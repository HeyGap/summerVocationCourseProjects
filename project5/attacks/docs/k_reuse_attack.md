# 泄露或重用随机数 k 攻击分析

## 攻击原理

在 ECDSA/SM2 数字签名算法中，签名过程使用随机数 k 来保证签名的随机性和安全性。如果随机数 k 被泄露或重用，攻击者可以从签名中恢复私钥。

## 数学推导

### SM2 签名算法

对于消息 m，SM2 签名算法：

1. 计算消息摘要 e = H(ZA || M)，其中 ZA 是用户标识摘要
2. 随机生成 k ∈ [1, n-1]
3. 计算点 (x₁, y₁) = kG
4. 计算 r = (e + x₁) mod n，若 r = 0 或 r + k = n，重新选择 k
5. 计算 s = d⁻¹(k - rd) mod n，若 s = 0，重新选择 k
6. 签名为 (r, s)

### 攻击数学原理

#### 情况1：随机数 k 泄露

如果攻击者知道签名 (r, s) 对应的随机数 k，则可以从签名方程恢复私钥：

```
s = d⁻¹(k - rd) mod n
```

重新排列得到：
```
sd = k - rd mod n
sd + rd = k mod n
d(s + r) = k mod n
d = k(s + r)⁻¹ mod n
```

#### 情况2：重用随机数 k

假设攻击者获得两个使用相同随机数 k 的签名：
- 消息 m₁ 的签名 (r₁, s₁)
- 消息 m₂ 的签名 (r₂, s₂)

由于使用相同的 k，有 r₁ = r₂ = r。

从签名方程：
```
s₁ = d⁻¹(k - rd) mod n
s₂ = d⁻¹(k - rd) mod n
```

由于都使用相同的 k 和 d，可得：
```
s₁ = s₂
```

这种情况下，攻击者可以通过以下方式恢复 k：

对于不同的消息 e₁ 和 e₂，签名方程为：
```
s₁ = d⁻¹(k - r·d) mod n  (对应 e₁)
s₂ = d⁻¹(k - r·d) mod n  (对应 e₂)
```

实际上，在标准的 ECDSA 中，签名方程是：
```
s₁ = k⁻¹(e₁ + r·d) mod n
s₂ = k⁻¹(e₂ + r·d) mod n
```

从这两个方程可以得到：
```
s₁ - s₂ = k⁻¹(e₁ - e₂) mod n
k = (e₁ - e₂)(s₁ - s₂)⁻¹ mod n
```

获得 k 后，可以恢复私钥：
```
d = r⁻¹(ks₁ - e₁) mod n
```

## 防护措施

1. **安全随机数生成**：确保每次签名都使用密码学安全的随机数生成器
2. **随机数唯一性**：确保每个签名使用不同的随机数
3. **随机数销毁**：签名完成后立即销毁随机数
4. **确定性签名**：使用 RFC 6979 标准的确定性随机数生成

## 攻击复杂度

- **时间复杂度**：O(1) - 一旦获得 k 或检测到重用，攻击是多项式时间的
- **空间复杂度**：O(1) - 只需要存储少量签名和计算结果
- **成功率**：100% - 在 k 泄露或重用的情况下攻击必定成功
