# SM3长度扩展攻击验证总结

## 项目概述

本项目成功实现了对SM3哈希算法的长度扩展攻击验证，展示了Merkle-Damgård结构哈希函数的固有安全缺陷，并演示了有效的防御方法。

## 实现文件

### 核心文件
1. **`length_extension_attack.c`** - 完整的长度扩展攻击实现
2. **`simple_attack_demo.c`** - 简化的演示程序，更直观易懂
3. **`LENGTH_EXTENSION_ATTACK.md`** - 详细的技术文档

### 基础SM3实现
- **`src/sm3.c`** - SM3算法标准实现
- **`include/sm3.h`** - SM3接口定义

## 攻击验证结果

### ✅ 攻击成功验证
两个演示程序都成功验证了长度扩展攻击：
- 攻击者在**不知道秘密密钥**的情况下
- 仅通过**已知的哈希值和消息长度**
- 成功计算出了**扩展消息的有效哈希值**

### 关键技术要点
1. **状态恢复**: 从哈希值恢复SM3内部状态
2. **填充计算**: 精确计算SM3填充规则
3. **上下文操作**: 正确设置SM3计算上下文
4. **哈希扩展**: 为恶意数据计算有效哈希

## 攻击场景演示

### 权限提升攻击
```
原始消息: user=alice&role=user
攻击结果: user=alice&role=user&role=admin
```
攻击者成功将普通用户权限提升为管理员权限。

### 完整攻击流程
1. **获取目标**: 已知 `H(secret_key || "user=alice&role=user")`
2. **计算填充**: 根据SM3规则计算必要的填充数据
3. **状态恢复**: 从哈希值恢复内部状态
4. **扩展攻击**: 计算 `H(原始消息 || 填充 || "&role=admin")`
5. **验证成功**: 攻击计算结果与直接计算结果完全匹配

## 安全影响分析

### 直接威胁
- **消息认证绕过**: 破坏基于哈希的完整性验证
- **权限提升**: 在访问控制场景中提升权限
- **签名伪造**: 伪造基于简单哈希的数字签名

### 受影响的应用模式
- `H(secret || message)` - 易受攻击 ❌
- `H(message || secret)` - 部分安全 ⚠️
- `HMAC(secret, message)` - 安全 ✅

## 防御方法验证

### 1. HMAC结构 ✅
```
HMAC = H((secret ⊕ opad) || H((secret ⊕ ipad) || message))
```
**验证结果**: 完全抵抗长度扩展攻击

### 2. 双重哈希 ✅
```
secure_hash = H(secret || H(secret || message))
```
**验证结果**: 有效防御长度扩展攻击

### 3. 后置密钥 ⚠️
```
hash = H(message || secret)
```
**验证结果**: 防御长度扩展攻击，但可能有其他风险

## 编译和运行

### 基本命令
```bash
# 编译所有程序
make all

# 运行完整演示
make attack

# 运行简化演示
make demo

# 清理编译文件
make clean
```

### 程序输出示例
```
🎯 攻击成功! 两个哈希值完全匹配!
💀 攻击者在不知道秘密密钥的情况下，成功计算出了扩展消息的哈希值
```

## 技术细节

### SM3填充规则
- 添加单个1位（0x80字节）
- 添加零填充使总长度 ≡ 448 (mod 512)
- 添加64位原始消息长度（大端序）

### 状态恢复机制
```c
void hash_to_state(const uint8_t *hash, uint32_t *state) {
    for (int i = 0; i < 8; i++) {
        state[i] = BE32(hash + i * 4);  // 大端序转换
    }
}
```

### 攻击上下文设置
```c
attack_ctx.count = original_len + padding_len;  // 关键：正确的字节计数
memcpy(attack_ctx.state, recovered_state, sizeof(recovered_state));
```

## 学习价值

### 密码学理论
- 理解Merkle-Damgård结构的设计缺陷
- 掌握哈希函数的内部工作机制
- 学习安全协议设计的重要性

### 实践技能
- 哈希函数的底层实现
- 二进制数据处理
- 密码学攻击的实际操作

### 安全意识
- 认识简单哈希方案的危险性
- 了解正确使用密码学原语的重要性
- 掌握有效的防御方法

## 结论

本项目成功验证了SM3哈希算法的长度扩展攻击漏洞，证明了：

1. **漏洞普遍性**: 所有Merkle-Damgård结构的哈希函数都存在此漏洞
2. **攻击可行性**: 攻击实现相对简单，危害严重
3. **防御必要性**: 必须使用HMAC等安全方法替代简单哈希
4. **教育价值**: 为密码学教学提供了直观的安全演示

### 最重要的启示
**永远不要使用 `H(secret || message)` 进行消息认证！**

应该使用经过验证的HMAC算法或其他安全的消息认证码（MAC）方案。

---
*本项目仅用于教学和学术研究目的，请勿用于恶意攻击。*
